<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Model Viewer</title>
    <link rel="stylesheet" href="/styles/global.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
</head>
<body>
    <div id="app" class="app">
        <div id="gallery-view" class="view">
            <header>
                <h2>Model Viewer</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                        <span id="theme-icon">‚òÄÔ∏è</span>
                    </button>
                    <div class="dropdown">
                        <button class="categories-btn" onclick="toggleDropdown()">
                            Categories
                        </button>
                        <div id="categories-list" class="dropdown-content"
                             hx-get="/categories"
                             hx-trigger="load">
                            <!-- Categories will be loaded here -->
                        </div>
                    </div>
                </div>
            </header>

            <main id="content" class="content">
                <div id="models-grid" class="models-grid"
                     hx-get="/models"
                     hx-trigger="load">
                    <!-- Models will be loaded here -->
                </div>
            </main>
        </div>

        <div id="viewer-view" class="view viewer-view hidden">
            <button class="back-btn" onclick="closeViewer()">‚óÇ</button>
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            <model-viewer id="model-viewer"
                         camera-controls
                         shadow-intensity="2"
                         exposure="1"
                         environment-image="neutral"
                         ar
                         ar-modes="webxr scene-viewer quick-look"
                         interaction-prompt="none"
                         camera-orbit="0deg 75deg 105%"
                         min-camera-orbit="auto auto 5%"
                         max-camera-orbit="auto auto 200%"
                         touch-action="pan-y pinch-zoom"
                         min-field-of-view="10deg"
                         max-field-of-view="90deg"
                         >
                <div class="progress-bar hide" slot="progress-bar">
                    <div class="update-bar"></div>
                </div>
            </model-viewer>
        </div>
    </div>

    <script>
        const modelViewer = document.querySelector('#model-viewer');
        const galleryView = document.querySelector('#gallery-view');
        const viewerView = document.querySelector('#viewer-view');
        const dropdown = document.querySelector('.dropdown');
        const loadingOverlay = document.querySelector('.loading-overlay');

        function toggleDropdown() {
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Close dropdown after selecting a category
        document.addEventListener('htmx:afterOnLoad', () => {
            dropdown.classList.remove('active');
        });

        function closeViewer() {
            viewerView.classList.add('hidden');
            galleryView.classList.remove('hidden');
            modelViewer.removeAttribute('loaded');
            modelViewer.src = '';
            history.pushState({ view: 'gallery' }, '', '/');
        }

        function showModel(modelPath) {
            // Reset states
            modelViewer.removeAttribute('loaded');
            modelViewer.src = '';
            loadingOverlay.classList.add('active');
            
            // Show viewer
            galleryView.classList.add('hidden');
            viewerView.classList.remove('hidden');

            // Update browser history
            history.pushState({ view: 'viewer', modelPath }, '', `?model=${encodeURIComponent(modelPath)}`);

            // Load new model
            requestAnimationFrame(() => {
                modelViewer.src = modelPath;
                modelViewer.cameraOrbit = '0deg 75deg 105%';
                modelViewer.resetTurntableRotation();
            });
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (event) => {
            if (event.state?.view === 'gallery' || !event.state) {
                viewerView.classList.add('hidden');
                galleryView.classList.remove('hidden');
                modelViewer.removeAttribute('loaded');
                modelViewer.src = '';
            } else if (event.state?.view === 'viewer' && event.state?.modelPath) {
                showModel(event.state.modelPath);
            }
        });

        // Set initial history state
        history.replaceState({ view: 'gallery' }, '', window.location.pathname);

        // Handle loading progress
        modelViewer.addEventListener('progress', (e) => {
            const progressBar = document.querySelector('.progress-bar');
            const updatingBar = document.querySelector('.update-bar');
            
            progressBar.classList.remove('hide');
            updatingBar.style.width = `${e.detail.totalProgress * 100}%`;
        });

        // Handle model loading completion
        modelViewer.addEventListener('load', () => {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.classList.add('hide');
            loadingOverlay.classList.remove('active');
            modelViewer.setAttribute('loaded', '');
        });

        // Handle model loading errors
        modelViewer.addEventListener('error', () => {
            loadingOverlay.classList.remove('active');
            alert('Error loading model');
        });

        // Theme handling
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            // Update model-viewer settings based on theme
            if (modelViewer) {
                if (newTheme === 'dark') {
                    modelViewer.exposure = 0.8;
                    modelViewer.shadowIntensity = 0.7;
                    modelViewer.environmentImage = 'neutral';
                } else {
                    modelViewer.exposure = 1;
                    modelViewer.shadowIntensity = 1;
                    modelViewer.environmentImage = 'neutral';
                }
            }
            
            // Save theme preference
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            // Apply theme-specific model-viewer settings
            if (modelViewer && savedTheme === 'dark') {
                modelViewer.exposure = 0.8;
                modelViewer.shadowIntensity = 0.7;
            }
        }

        // Fix for iOS Safari full screen
        function fixIOSViewport() {
            document.documentElement.style.height = `${window.innerHeight}px`;
        }
        window.addEventListener('resize', fixIOSViewport);
        fixIOSViewport();
    </script>
</body>
</html> 