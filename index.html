<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Viewer</title>
    <link rel="stylesheet" href="/styles/global.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
</head>
<body>
    <div id="app" class="app">
        <div id="gallery-view" class="view">
            <header>
                <h2>Model Viewer</h2>
                <div class="dropdown">
                    <button class="categories-btn" onclick="toggleDropdown()">
                        Categories
                    </button>
                    <div id="categories-list" class="dropdown-content"
                         hx-get="/api/categories"
                         hx-trigger="load">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </header>

            <main id="content" class="content">
                <div id="models-grid" class="models-grid"
                     hx-get="/api/models/all"
                     hx-trigger="load">
                    <!-- Models will be loaded here -->
                </div>
            </main>
        </div>

        <div id="viewer-view" class="view viewer-view hidden">
            <button class="back-btn" onclick="closeViewer()">â—‚</button>
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            <model-viewer id="model-viewer"
                         camera-controls
                         auto-rotate
                         rotation-per-second="30deg"
                         shadow-intensity="1"
                         shadow-softness="1"
                         exposure="1"
                         environment-image="neutral"
                         auto-rotate-delay="0"
                         ar
                         ar-modes="webxr scene-viewer quick-look"
                         interaction-prompt="none"
                         camera-orbit="0deg 75deg 105%"
                         min-camera-orbit="auto auto 5%"
                         max-camera-orbit="auto auto 200%"
                         touch-action="pan-y">
                <div class="progress-bar hide" slot="progress-bar">
                    <div class="update-bar"></div>
                </div>
            </model-viewer>
        </div>
    </div>

    <script>
        const modelViewer = document.querySelector('#model-viewer');
        const galleryView = document.querySelector('#gallery-view');
        const viewerView = document.querySelector('#viewer-view');
        const dropdown = document.querySelector('.dropdown');
        const loadingOverlay = document.querySelector('.loading-overlay');

        function toggleDropdown() {
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Close dropdown after selecting a category
        document.addEventListener('htmx:afterOnLoad', () => {
            dropdown.classList.remove('active');
        });

        function closeViewer() {
            viewerView.classList.add('hidden');
            galleryView.classList.remove('hidden');
            modelViewer.removeAttribute('loaded');
            modelViewer.src = '';
            history.pushState({ view: 'gallery' }, '', '/');
        }

        function showModel(modelPath) {
            // Reset states
            modelViewer.removeAttribute('loaded');
            modelViewer.src = '';
            loadingOverlay.classList.add('active');
            
            // Show viewer
            galleryView.classList.add('hidden');
            viewerView.classList.remove('hidden');

            // Update browser history
            history.pushState({ view: 'viewer', modelPath }, '', `?model=${encodeURIComponent(modelPath)}`);

            // Load new model
            requestAnimationFrame(() => {
                modelViewer.src = modelPath;
                modelViewer.cameraOrbit = '0deg 75deg 105%';
                modelViewer.resetTurntableRotation();
            });
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (event) => {
            if (event.state?.view === 'gallery' || !event.state) {
                viewerView.classList.add('hidden');
                galleryView.classList.remove('hidden');
                modelViewer.removeAttribute('loaded');
                modelViewer.src = '';
            } else if (event.state?.view === 'viewer' && event.state?.modelPath) {
                showModel(event.state.modelPath);
            }
        });

        // Set initial history state
        history.replaceState({ view: 'gallery' }, '', window.location.pathname);

        // Handle loading progress
        modelViewer.addEventListener('progress', (e) => {
            const progressBar = document.querySelector('.progress-bar');
            const updatingBar = document.querySelector('.update-bar');
            
            progressBar.classList.remove('hide');
            updatingBar.style.width = `${e.detail.totalProgress * 100}%`;
        });

        // Handle model loading completion
        modelViewer.addEventListener('load', () => {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.classList.add('hide');
            loadingOverlay.classList.remove('active');
            modelViewer.setAttribute('loaded', '');
        });

        // Handle model loading errors
        modelViewer.addEventListener('error', () => {
            loadingOverlay.classList.remove('active');
            alert('Error loading model');
        });
    </script>
</body>
</html> 